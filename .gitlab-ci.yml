stages:
  - build
  - test
  - deploy

cache:
  paths:
    - node_modules/
    - BackEnd/.m2/

build:
  stage: build
  image: ruby:3.1 # Custom image without Node.js
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    MYSQL_DATABASE: djerba
    MYSQL_USER: iheb
    MYSQL_PASSWORD: Gharbix23*
    MYSQL_ROOT_PASSWORD: Gharbix23*
  script:
    # Install Node.js and npm
    - echo "Installing Node.js and npm..."
    - apt-get update && apt-get install -y curl
    - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    - apt-get install -y nodejs

    # Frontend build
    - echo "Building Frontend..."
    - cd FrontEnd
    - npm ci --legacy-peer-deps  # Use --legacy-peer-deps to resolve dependency issues
    - npm run build --prod

    # Backend build
    - echo "Building Backend..."
    - apt-get update
    - apt-get install -y default-mysql-client # Correct package for MySQL client
    - echo "Waiting for MySQL to be ready..."
    - until mysqladmin ping -h mysql --silent; do sleep 1; done
    - cd ../BackEnd
    - mvn clean package
  artifacts:
    paths:
      - FrontEnd/dist/
      - BackEnd/target/*.jar

test:
  image: node:20
  stage: test
  script:
    - cd FrontEnd
    - npm run test -- --watch=false
    - cd ../BackEnd
    - mvn test

deploy:
  image: node:20
  stage: deploy
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    MYSQL_DATABASE: djerba
    MYSQL_USER: iheb
    MYSQL_PASSWORD: Gharbix23*
    MYSQL_ROOT_PASSWORD: Gharbix23*
  script:
    - |
      # Deploy Frontend
      echo "Deploying Frontend..."
      npm install -g http-server
      cd FrontEnd/dist/
      http-server -p 4200 &  # Serve the frontend on port 4200
      sleep 10

      # Deploy Backend
      echo "Deploying Backend..."
      cd ../BackEnd
      java -jar target/*.jar &  # Start the backend
      echo "Backend running at: http://localhost:8080"
      curl -s http://localhost:8080 || { echo "Backend failed to start!"; exit 1; }
      echo "Frontend running at: http://localhost:4200"

  environment:
    name: production
    url: http://localhost:4200
