stages:
  - build
  - deploy

cache:
  paths:
    - node_modules/
    - BackEnd/.m2/

build:
  stage: build
  image: cimg/openjdk:21.0-node # Image avec Java 21 + Node.js préinstallé
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    MYSQL_DATABASE: djerba
    MYSQL_USER: iheb
    MYSQL_PASSWORD: Gharbix23*
    MYSQL_ROOT_PASSWORD: Gharbix23*
  script:
    - echo "Verifying Java version..."
    - java -version  # Vérifier que Java 21 est bien installé

    - echo "Installing Node.js dependencies..."
    - cd FrontEnd
    - npm ci --legacy-peer-deps
    - npm run build --prod # Ensure this is focusing only on client-side build
    - cd ..

    - echo "Building Backend..."
    - apt-get update && apt-get install -y default-mysql-client maven
    - echo "Waiting for MySQL to be ready..."
    - until mysqladmin ping -h mysql --silent; do sleep 1; done
    - cd BackEnd
    - mvn clean package
    - cd ..

  artifacts:
    paths:
      - FrontEnd/dist/
      - BackEnd/target/*.jar

deploy:
  stage: deploy
  image: cimg/openjdk:21.0-node # Même image que le build pour assurer la compatibilité
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    MYSQL_DATABASE: djerba
    MYSQL_USER: iheb
    MYSQL_PASSWORD: Gharbix23*
    MYSQL_ROOT_PASSWORD: Gharbix23*
  script:
    - echo "Deploying Frontend..."
    - npm install -g http-server
    - if [ -d "FrontEnd/dist" ]; then 
        cd FrontEnd/dist && nohup http-server -p 4200 > ../../frontend.log 2>&1 & 
      else 
        echo "Frontend build not found!" && exit 1 
      fi

    - echo "Deploying Backend..."
    - BACKEND_JAR=$(ls BackEnd/target/*.jar | head -n 1)
    - if [ -f "$BACKEND_JAR" ]; then 
        cd BackEnd && nohup java -jar "$BACKEND_JAR" > ../backend.log 2>&1 & 
      else 
        echo "Backend build not found!" && exit 1 
      fi

    - echo "Waiting for Backend to be available..."
    - sleep 10
    - curl -s http://localhost:8080 || { echo "Backend failed to start!"; exit 1; }

    - echo "Frontend running at:" # Add actual frontend URL if required
    - echo "Backend running at:" # Add actual backend URL if required

  environment:
    name: production
    url: http://localhost:4200
