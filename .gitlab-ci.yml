build:
  stage: build
  image: node:18.20.5
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    MYSQL_DATABASE: djerba
    MYSQL_USER: iheb
    MYSQL_PASSWORD: Gharbix23*
    MYSQL_ROOT_PASSWORD: Gharbix23*
  script:
    - echo "Installing Java 21..."
    # Install Java 21 manually by downloading from OpenJDK
    - apt-get update
    - apt-get install -y wget
    - wget https://download.java.net/java/GA/jdk21/9/GPL/openjdk-21_linux-x64_bin.tar.gz
    - tar -xzf openjdk-21_linux-x64_bin.tar.gz
    - mv jdk-21 /opt/
    - update-alternatives --install /usr/bin/java java /opt/jdk-21/bin/java 1
    - update-alternatives --config java
    - java -version  # Verify Java installation

    - echo "Installing Node.js dependencies..."
    - cd FrontEnd
    - npm ci --legacy-peer-deps
    - npm run build --prod
    - cd ..

    - echo "Building Backend..."
    - apt-get update && apt-get install -y default-mysql-client
    - echo "Waiting for MySQL to be ready..."
    - until mysqladmin ping -h mysql --silent; do sleep 1; done
    - cd BackEnd
    - mvn clean package
    - cd ..

  artifacts:
    paths:
      - FrontEnd/dist/
      - BackEnd/target/*.jar


deploy:
  image: node:18.20.5
  stage: deploy
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    MYSQL_DATABASE: djerba
    MYSQL_USER: iheb
    MYSQL_PASSWORD: Gharbix23*
    MYSQL_ROOT_PASSWORD: Gharbix23*
  script:
    - echo "Deploying Frontend..."
    - npm install -g http-server
    - cd FrontEnd/dist/
    - http-server -p 4200 &  # Run http-server in the background to serve the frontend
    - sleep 10  # Wait for the server to start
    
    - echo "Deploying Backend..."
    - cd ../BackEnd
    - java -jar target/*.jar &  # Start the backend server in the background
    - sleep 10  # Wait for the backend to be ready
    - curl -s http://localhost:8080 || { echo "Backend failed to start!"; exit 1; }

  environment:
    name: production
    url: http://localhost:4200
